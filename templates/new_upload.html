{% extends 'base.html' %}

{% load static %}

{% block title %}Upload a new Image{% endblock %}

{% block content %}
    <div class="my-4">
        <form id="submit_image" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label for="id_title">Title</label>
                <input type="text" class="form-control" id="id_title" name="title">
            </div>
            <div class="form-group">
                <label for="id_description">Description</label>
                <input type="text" class="form-control" id="id_description" name="description">
            </div>
            <table id="gallery" class="table table-bordered">
                <thead>
                    <tr>
                        <th>Added Images</th>
                    </tr>
                </thead>
                <tbody style="color: #117a8b">
                </tbody>
            </table>
            <div class="form-group">
                <label for="id_image">Add image to upload</label>
                <input type="file" class="form-group" id="id_image" name="images" multiple>
            </div>
            <button type="submit" class="btn btn-success" id="submitBtn">Upload</button>
        </form>
    </div>

{% endblock %}

{% block javascript %}

    {# JQUERY FILE UPLOAD SCRIPTS #}
    <script src="{% static 'js/jquery-file-upload/vendor/jquery.ui.widget.js' %}"></script>
    <script src="{% static 'js/jquery-file-upload/jquery.fileupload.js' %}"></script>
    <script src="{% static 'js/jquery-file-upload/jquery.iframe-transport.js' %}"></script>

    <script type="text/javascript">
        //Function to get csrf_token via cookie

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                let cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = jQuery.trim(cookies[i]);
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        let frm = $('#submit_image');

        let formData = new FormData();

        let reader = new FileReader();

        $('#id_image').on('input', function () {
            let ins = document.getElementById('id_image').files.length;
            for (let x = 0; x < ins; x++) {
                formData.append("images[]", document.getElementById('id_image').files[x]);
            }
            $("#gallery tbody").prepend(
              "<tr><td>" + document.getElementById('id_image').files[0].name + "</td></tr>"
            );
            console.log($(this)[0].files[0]);
        });

        frm.submit( function() {

            let csrftoken = getCookie('csrftoken');
            let title = $('#id_title').val();
            let description = $('#id_description').val();
            //let images = $('#id_image')[0].files;
            let str = title + '  ' + description;

            alert(str);
            formData.append('title',title);
            formData.append('description',description);
            formData.append('csrfmiddlewaretoken', csrftoken);

            $.ajax({
                type: 'post',
                url: '/image/new/',
                contentType: false,
                processData:false,
                data: formData,
                success: function (data) {
                    alert(data);
                },
                error: function (err) {
                    alert("Something went wrong!!" + err);
                }
            });
        });
    </script>
{% endblock %}
